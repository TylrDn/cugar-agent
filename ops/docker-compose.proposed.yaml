version: "3.9"

services:
  orchestrator:
    image: ghcr.io/example/cugar-orchestrator:latest
    env_file:
      - ./env/orchestrator.env
    environment:
      # LANGFLOW_HOST: http://langflow:7860
      # ALTK_HOST: http://altk:8080
      # AGENT_TRACE_SAMPLE_RATE: 0.1
    depends_on:
      - mcp.e2b
      - mcp.fs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    profiles: ["tier1"]

  mcp.e2b:
    image: ghcr.io/example/mcp-e2b:latest
    environment:
      # E2B_API_KEY: ${E2B_API_KEY}
    volumes:
      - type: bind
        source: ../
        target: /workdir
        read_only: false
    healthcheck:
      test: ["CMD", "true"]
    profiles: ["tier1"]

  mcp.fs:
    image: ghcr.io/example/mcp-fs:latest
    volumes:
      - type: bind
        source: ../
        target: /workspace
        read_only: true
      - type: bind
        source: ../artifacts
        target: /workspace/artifacts
        read_only: false
    healthcheck:
      test: ["CMD", "true"]
    profiles: ["tier1"]

  mcp.web-slim:
    image: node:20-slim
    environment:
      # WEB_PROFILE: node-slim
      # BROWSER_BASE_URL: http://browser:3000
    command: ["node", "index.js"]
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
    profiles: ["tier1"]

  mcp.web-full:
    image: node:20
    environment:
      # WEB_PROFILE: node-full
      # BROWSER_BASE_URL: http://browser:3000
    command: ["node", "index.js"]
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
    profiles: ["tier1"]

  mcp.vcs:
    image: ghcr.io/example/mcp-vcs:latest
    read_only: true
    volumes:
      - type: bind
        source: ../repos
        target: /workspace/repos
        read_only: true
    healthcheck:
      test: ["CMD", "true"]
    profiles: ["tier1"]

  observability:
    image: otel/opentelemetry-collector:latest
    environment:
      # OTEL_EXPORTER_OTLP_ENDPOINT: http://otel:4318
      # AGENT_TRACE_SAMPLE_RATE: 0.1
    healthcheck:
      test: ["CMD", "true"]
    profiles: ["tier2"]

  vector-db:
    image: ghcr.io/example/vector-db:latest
    environment:
      # VECTOR_DB_URL: http://vector-db:8080
    volumes:
      - type: bind
        source: ../vector
        target: /workspace/vector
        read_only: false
    healthcheck:
      test: ["CMD", "true"]
    profiles: ["tier2"]
